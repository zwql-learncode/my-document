---
id: vsa_milan
title: Vertical Slice Architecture
---

# Vertical Slice Architecture (VSA) Document

Dá»‹ch tá»« bÃ i viáº¿t [Vertical Slice Architecture](https://www.milanjovanovic.tech/blog/vertical-slice-architecture) cá»§a Milan JovanoviÄ‡

`Kiáº¿n trÃºc phÃ¢n lá»›p` (Layered Architectures) lÃ  ná»n táº£ng cá»§a nhiá»u há»‡ thá»‘ng pháº§n má»m. Tuy nhiÃªn, mÃ´ hÃ¬nh nÃ y tá»• chá»©c há»‡ thá»‘ng theo `cÃ¡c lá»›p ká»¹ thuáº­t`(technical layers), dáº«n Ä‘áº¿n `sá»± liÃªn káº¿t giá»¯a cÃ¡c lá»›p` (cohesion between layers) khÃ¡ tháº¥p. NhÆ°ng náº¿u ta muá»‘n tá»• chá»©c há»‡ thá»‘ng dá»±a trÃªn cÃ¡c tÃ­nh nÄƒng (features) thÃ¬ sao? `Giáº£m thiá»ƒu liÃªn káº¿t` (Minimize coupling) giá»¯a `cÃ¡c tÃ­nh nÄƒng khÃ´ng liÃªn quan` (unrelated features) vÃ  `tÄƒng cÆ°á»ng liÃªn káº¿t`(maximize coupling) trong `má»™t tÃ­nh nÄƒng duy nháº¥t` (single feature). HÃ´m nay, tÃ´i sáº½ giá»›i thiá»‡u vá» `Vertical Slice Architecture`, má»™t máº«u kiáº¿n trÃºc giÃºp Ä‘áº¡t Ä‘Æ°á»£c Ä‘iá»u Ä‘Ã³.

## 1. Váº¥n Äá» Cá»§a Layered Architectures (Kiáº¿n TrÃºc PhÃ¢n Lá»›p)

Kiáº¿n trÃºc phÃ¢n lá»›p tá»• chá»©c há»‡ thá»‘ng pháº§n má»m thÃ nh cÃ¡c táº§ng (layers) hoáº·c lá»›p (tiers). Má»—i táº§ng thÆ°á»ng Ä‘Æ°á»£c triá»ƒn khai dÆ°á»›i dáº¡ng má»™t project riÃªng trong solution (cÃ¡ch triá»ƒn khai trong ASP.NET). Má»™t sá»‘ kiáº¿n trÃºc phÃ¢n lá»›p phá»• biáº¿n cÃ³ thá»ƒ ká»ƒ Ä‘áº¿n nhÆ° N-Layer(aka mÃ´ hÃ¬nh 3 lá»›p), Clean Architecture,...

Má»¥c tiÃªu chÃ­nh cá»§a Layered Architectures lÃ  `separation of concerns` giá»¯a cÃ¡c thÃ nh pháº§n khÃ¡c nhau trong há»‡ thá»‘ng. Äiá»u nÃ y giÃºp há»‡ thá»‘ng pháº§n má»m dá»… hiá»ƒu, dá»… báº£o trÃ¬. VÃ  nÃ³ mang láº¡i ráº¥t nhiá»u lá»£i Ã­ch cho kiáº¿n trÃºc pháº§n má»m nhÆ°: `tÃ­nh báº£o trÃ¬` (maintainability), `tÃ­nh linh hoáº¡t`(flexibility) vÃ  `loose coupling`

- `separation of concerns`: Chia nhá» há»‡ thá»‘ng thÃ nh cÃ¡c pháº§n riÃªng biá»‡t, má»—i pháº§n chá»‰ chá»‹u trÃ¡ch nhiá»‡m má»™t nhiá»‡m vá»¥ cá»¥ thá»ƒ.
- `loose coupling`: Khá»›p ná»‘i lá»ng láº»o. Tá»©c lÃ  cÃ¡c thÃ nh pháº§n Ã­t phá»¥ thuá»™c vÃ o nhau.

Tuy nhiÃªn, Layered Architectures cÅ©ng Ã¡p Ä‘áº·t nhá»¯ng rÃ ng buá»™c hoáº·c quy táº¯c cá»©ng nháº¯c lÃªn há»‡ thá»‘ng. HÆ°á»›ng sá»± phá»¥ thuá»™c giá»¯a cÃ¡c táº§ng Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trÆ°á»›c (The direction of dependencies between layers is pre-determined).

![áº¢nh minh há»a: Clean Architecture káº¿t há»£p vá»›i Domain-Driven Design](/img/milan/clean_architecture.png)

> _Clean Architecture káº¿t há»£p vá»›i Domain-Driven Design_

Láº¥y vÃ­ dá»¥ vá»›i Clean Architecture

- Domain layer (chá»©a Entities, business logic) khÃ´ng Ä‘Æ°á»£c phá»¥ thuá»™c vÃ o báº¥t cá»© thÃ nh pháº§n nÃ o.
- Application layer (chá»©a tráº¡ng thÃ¡i cá»§a á»©ng dá»¥ng, command, queries) tham chiáº¿u Ä‘áº¿n Domain.
- Infrastructure layer (chá»©a data access, code cÆ¡ sá»Ÿ háº¡ táº§ng) tham chiáº¿u Ä‘áº¿n Application vÃ  Domain.
- Presentation layer (chá»©a API hoáº·c UI) tham chiáº¿u Ä‘áº¿n Application vÃ  Domain.

Káº¿t quáº£ lÃ  báº¡n sáº½ cÃ³ má»©c Ä‘á»™ `high coupling` (khá»›p ná»‘i cháº·t cháº½) bÃªn trong má»—i layer nhÆ°ng má»©c Ä‘á»™ `low coupling` (khá»›p ná»‘i lá»ng láº»o) giá»¯a cÃ¡c táº§ng. Äiá»u nÃ y khÃ´ng cÃ³ nghÄ©a lÃ  Layered Architecture lÃ  tá»‡, nhÆ°ng nÃ³ Ä‘á»“ng nghÄ©a vá»›i viá»‡c sáº½ cÃ³ nhiá»u abstractions giá»¯a cÃ¡c layer. MÃ  cÃ ng nhiá»u abstractions thÃ¬ Ä‘á»™ phá»©c táº¡p tÄƒng lÃªn, vÃ¬ cÃ³ nhiá»u thÃ nh pháº§n cáº§n pháº£i báº£o trÃ¬ hÆ¡n.

## 2. Vertical Slice Architecture (VSA) lÃ  gÃ¬?

TÃ´i láº§n Ä‘áº§u nghe vá» Vertical Slice Architecture tá»« Jimmy Bogard, ngÆ°á»i cÅ©ng lÃ  tÃ¡c giáº£ cá»§a má»™t sá»‘ thÆ° viá»‡n mÃ£ nguá»“n má»Ÿ ná»•i tiáº¿ng nhÆ° MediatR vÃ  AutoMapper.

Vertical Slice Architecture ra Ä‘á»i nháº±m giáº£i quyáº¿t nhá»¯ng báº¥t cáº­p khi lÃ m viá»‡c vá»›i Layered Architecture. YÃªu cáº§u báº¡n pháº£i chá»‰nh sá»­a nhiá»u layer khÃ¡c nhau Ä‘á»ƒ triá»ƒn khai má»™t tÃ­nh nÄƒng, gÃ¢y phá»©c táº¡p vÃ  máº¥t thá»i gian.

TÆ°á»Ÿng tÆ°á»£ng quÃ¡ trÃ¬nh thÃªm má»™t tÃ­nh nÄƒng má»›i trong Clean Architecture káº¿t há»£p vá»›i CQRS vÃ  DDD nhÆ° tháº¿ nÃ y:

- Cáº­p nháº­t Entites trong Domain layer.
- Chá»‰nh sá»­a business logic cá»§a Validation trong Application layer.
- Sá»­a hoáº·c thÃªm má»›i use case trong command handler (vá»›i MediatR) trong Application layer.
- Sá»­a hoáº·c táº¡o má»›i má»™t API endpoint trong trong Presentation layer.

Ta cÃ³ thá»ƒ thÃ¡y ráº±ng `tÃ­nh káº¿t ná»‘i` (cohesion) trong Layered Architecture tháº¥p vÃ¬ báº¡n pháº£i táº¡o nhiá»u file á»Ÿ cÃ¡c layer khÃ¡c nhau. Vertical Slice Architecture cho phÃ©p báº¡n tiáº¿p cáº­n theo cÃ¡ch khÃ¡c:

- Giáº£m thiá»ƒu sá»± liÃªn káº¿t giá»¯a cÃ¡c slice (low coupling giá»¯a cÃ¡c slice).
- TÄƒng cÆ°á»ng káº¿t ná»‘i bÃªn trong má»™t slice (high cohesion trong má»—i slice).

DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡ch báº¡n cÃ³ thá»ƒ hÃ¬nh dung vá» Vertical Slice Architecture:

![áº¢nh minh há»a: Vertical Slice Architecture](/img/milan/vertical_slice_architecture.png)

> _Vertical Slice Architecture_

Táº¥t cáº£ cÃ¡c file liÃªn quan (tá»« API end point cho Ä‘áº¿n business logic) Ä‘áº¿n má»™t use case Ä‘á»u Ä‘Æ°á»£c nhÃ³m vÃ o cÃ¹ng má»™t feature folder. Äiá»u nÃ y giÃºp tÃ­nh káº¿t ná»‘i (cohesion) trong má»™t use case ráº¥t cao, tá»« Ä‘Ã³ Ä‘Æ¡n giáº£n hÃ³a quÃ¡ trÃ¬nh phÃ¡t triá»ƒn.

Má»—i má»™t feature folder chÃ­nh lÃ  má»™t vertical slice. Má»—i vertical slice cáº¯t dá»c, xuyÃªn suá»‘t qua táº¥t cáº£ cÃ¡c layer.

Nhá» cÃ¡ch táº­p trung vÃ o tÃ­nh nÄƒng, báº¡n dá»… dÃ ng tÃ¬m tháº¥y táº¥t cáº£ cÃ¡c thÃ nh pháº§n liÃªn quan Ä‘áº¿n má»™t `feature` (tÃ­nh nÄƒng) vÃ¬ chÃºng Ä‘Æ°á»£c Ä‘áº·t gáº§n nhau.

## 3. Triá»ƒn khai Vertical Slice Architecture (VSA) vá»›i CQRS

Náº¿u báº¡n Ä‘ang xÃ¢y dá»±ng má»™t API sá»­ dá»¥ng CQRS. Vá»›i viá»‡c sá»­ dá»¥ng VSA, má»—i slice táº­p trung háº¹p vÃ o má»™t tÃ­nh nÄƒng cá»¥ thá»ƒ. Äiá»u nÃ y cho phÃ©p báº¡n xá»­ lÃ½ tá»«ng use case má»™t cÃ¡ch Ä‘á»™c láº­p, tÃ¹y chá»‰nh cÃ¡ch triá»ƒn khai sao cho phÃ¹ há»£p nháº¥t. VÃ­ dá»¥:

- Má»™t vertical slice cÃ³ thá»ƒ dÃ¹ng EF Core ORM Ä‘á»ƒ thá»±c hiá»‡n truy váº¥n GET.
- Má»™t vertical slice khÃ¡c cÃ³ thá»ƒ sá»­ dá»¥ng Dapper ORM vá»›i truy váº¥n SQL thuáº§n Ä‘á»ƒ láº¥y dá»¯ liá»‡u.

Má»™t cÃ¡ch tiáº¿p cáº­n thÃº vá»‹ Ä‘á»ƒ tá»• chá»©c API theo tÃ­nh nÄƒng lÃ  sá»­ dá»¥ng REPR Pattern.REPR lÃ  viáº¿t táº¯t cá»§a:

- Request â€“ Äá»‹nh nghÄ©a dá»¯ liá»‡u Ä‘áº§u vÃ o cá»§a API.
- EndPoint â€“ Xá»­ lÃ½ yÃªu cáº§u, gá»i logic nghiá»‡p vá»¥.
- Response â€“ Äá»‹nh nghÄ©a dá»¯ liá»‡u tráº£ vá» cho client.

MÃ´ hÃ¬nh nÃ y phÃ¹ há»£p hoÃ n toÃ n vá»›i Vertical Slice Architecture, vÃ¬ má»—i API Ä‘Æ°á»£c nhÃ³m láº¡i theo request cá»¥ thá»ƒ thay vÃ¬ chia theo táº§ng. Báº¡n cÃ³ thá»ƒ dá»… dÃ ng triá»ƒn khai REPR Pattern vá»›i thÆ° viá»‡n MediatR.

DÆ°á»›i Ä‘Ã¢y lÃ  má»™t vÃ­ dá»¥ vá» cáº¥u trÃºc solution trong .NET. Báº¡n sáº½ tháº¥y thÆ° má»¥c Features, nÆ¡i chá»©a cÃ¡c vertical slices. Má»—i slice triá»ƒn khai má»™t yÃªu cáº§u API (hoáº·c má»™t use case).

```
ğŸ”— RunTracker.API
|__ ğŸ“ Database
|__ ğŸ“ Entities
    |__ #ï¸âƒ£ Activity.cs
    |__ #ï¸âƒ£ Workout.cs
    |__ #ï¸âƒ£ ...
|__ ğŸ“ Features
    |__ ğŸ“ Activities
        |__ ğŸ“ GetActivity
            |__ #ï¸âƒ£ ActivityResponse.cs
            |__ #ï¸âƒ£ GetActivityEndpoint.cs
            |__ #ï¸âƒ£ GetActivityQuery.cs
            |__ #ï¸âƒ£ GetActivityQueryHandler.cs
        |__ ğŸ“ CreateActivity
            |__ #ï¸âƒ£ CreateActivity.cs
                |__ #ï¸âƒ£ CreateActivity.Command.cs
                |__ #ï¸âƒ£ CreateActivity.Endpoint.cs
                |__ #ï¸âƒ£ CreateActivity.Handler.cs
                |__ #ï¸âƒ£ CreateActivity.Validator.cs
    |__ ğŸ“ Workouts
    |__ ğŸ“ ...
|__ ğŸ“ Middleware
|__ ğŸ“„ appsettings.json
|__ ğŸ“„ appsettings.Development.json
|__ #ï¸âƒ£ Program.cs
```

## 4. Tá»•ng káº¿t

Lá»£i Ã­ch cá»§a VSA lÃ :

- Khi thÃªm tÃ­nh nÄƒng má»›i, báº¡n chá»‰ cáº§n thÃªm code, khÃ´ng cáº§n chá»‰nh sá»­a code dÃ¹ng chung. Äiá»u nÃ y giÃºp trÃ¡nh `side effects` lÃªn cÃ¡c pháº§n khÃ¡c cá»§a há»‡ thá»‘ng.

- `side effects`: tÃ¡c dá»¥ng phá»¥ - tÃ¡c dá»¥ng ngoÃ i Ã½ muá»‘n

Tuy nhiÃªn, VSA cÃ³ váº¥n Ä‘á» lÃ :

- VÃ¬ pháº§n lá»›n logic nghiá»‡p vá»¥ náº±m trong tá»«ng use case riÃªng láº», báº¡n cáº§n phÃ¡t hiá»‡n sá»›m code smells (dáº¥u hiá»‡u thiáº¿t káº¿ kÃ©m). Pháº£i Ä‘áº£m báº£o má»—i slice cÃ³ tÃ­nh Ä‘á»™c láº­p vÃ  kháº£ nÄƒng báº£o trÃ¬.

- Váº§n Ä‘áº¿ vá» trÃ¹ng láº·p code giá»¯a cÃ¡c pháº§n: Äáº·c biá»‡t vá»›i cÃ¡c chá»©c nÄƒng dÃ¹ng chung.

- Náº¿u use case phÃ¡t triá»ƒn quÃ¡ lá»›n, nÃ³ cÃ³ thá»ƒ trá»Ÿ nÃªn cá»“ng ká»nh vÃ  lÃ m quÃ¡ nhiá»u viá»‡c. Khi Ä‘Ã³, báº¡n cáº§n refactor (tÃ¡i cáº¥u trÃºc) báº±ng cÃ¡ch Ä‘áº©y logic xuá»‘ng táº§ng domain, giÃºp há»‡ thá»‘ng dá»… báº£o trÃ¬ hÆ¡n.

Vertical Slice Architecture sáº½ phÃ¹ há»£p hÆ¡n vá»›i há»‡ thá»‘ng sá»­ dá»¥ng káº¿t há»£p Microservices & CQRS. NÆ¡i mÃ  má»—i Service hay cÃ¡c thÃ nh pháº§n cá»§a nÃ³ lÃ  Command vÃ  Query cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p mÃ  khÃ´ng cáº§n biáº¿t Ä‘áº¿n cÃ¡c Service hay Command vÃ  Query khÃ¡c. Sá»‘ lÆ°á»£ng API cho má»—i á»©ng dá»¥ng cÅ©ng khÃ´ng quÃ¡ lá»›n nhÆ° monolithic.

CÃ¡c kiáº¿n trÃºc phÃ¢n táº§ng nhÆ° Clean Architecture tá»• chá»©c solution theo layer, dáº«n Ä‘áº¿n cáº¥u trÃºc thÆ° má»¥c Ä‘Æ°á»£c nhÃ³m theo `khÃ­a cáº¡nh ká»¹ thuáº­t` (technical concerns). NgÆ°á»£c láº¡i, Vertical Slice Architecture tá»• chá»©c code theo tá»«ng feature (tÃ­nh nÄƒng) hoáº·c use case.
